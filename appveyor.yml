environment:
  nodejs_version: "0.10.36"

branches:
  only:
    - prod
    - /v\d+\.\d+\.\d+/

platform:
  - x86
  - x64

install:
  - ps: Install-Product node $env:nodejs_version $env:platform
  # Setup
  - npm install
  # download Meteor
  - ps: Start-FileDownload 'https://s3.amazonaws.com/meteor-windows/InstallMeteor.exe'
  # install meteor
  - .\installMeteor.exe /passive
  # download NSIS
  - ps: choco install -y nsis -pre
  # Restart
  - ps: Start-Sleep -s 5
  - ps: Restart-Computer -Force

build_script:
  - ps: Start-Sleep -s 5
  - set PATH=C:\Program Files (x86)\NSIS;%PATH%
  # Supress SCSS error
  - node scripts/scss
  # For some reason it is necessary to split up the commands
  - node scripts/download --platform=win32 --arch=x64
  - node scripts/prepare --platform=win32 --arch=x64
  - npm run clean:win:x64
  - npm run build:win:%platform%
  # Update node
  - ps: Install-Product node 0.12.7 $env:platform
  - node --version
  - npm run pack:win:%platform%

after_build:
  - 7z a GrandView-%APPVEYOR_REPO_TAG_NAME%-win32-%platform%-installer.zip "%APPVEYOR_BUILD_FOLDER%\dist\windows\%platform%\GrandView Setup.exe"

deploy:
  provider: GitHub
  auth_token:
    secure: tNMKx8kVItLg0Henj9BJJNB+IUTkaa1ScGiJ7WBq6/TxST6l7MhHGe4k0omB6H5V
  artifact: "GrandView-$(APPVEYOR_REPO_TAG_NAME)-win32-$(platform),GrandView-$(APPVEYOR_REPO_TAG_NAME)-win32-$(platform)-installer"
  draft: false
  prerelease: false
  on:
    appveyor_repo_tag: true

artifacts:
  - path: dist\windows\x86\GrandView-win32-ia32
    name: GrandView-$(APPVEYOR_REPO_TAG_NAME)-win32-$(platform)

  - path: GrandView-$(APPVEYOR_REPO_TAG_NAME)-win32-$(platform)-installer.zip
    name: GrandView-$(APPVEYOR_REPO_TAG_NAME)-win32-$(platform)-installer
