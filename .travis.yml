language: node_js
node_js:
  - "7.10.0"

sudo: required
dist: trusty

# multiple oses when nodejs env comes to osx on travis
os:
 - linux
 - osx

env:
  global:
    - |
      APP_VERSION="$(node -p 'require("./package.json").version')"
  matrix:
    - ARCH=x64 ARCH_NAME=x64
    - ARCH=x86 ARCH_NAME=ia32

branches:
  only:
    - /v\d+\.\d+\.\d+(-beta.\d+)?/

install:
  # Install meteor
  - curl https://install.meteor.com/ | /bin/sh
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo apt-get install --no-install-recommends -y g++ build-essential gcc-multilib g++-multilib icnsutils graphicsmagick xz-utils; fi
  # Install modules
  - npm install

script:
  # Build app for Linux
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then npm run build:$TRAVIS_OS_NAME:$ARCH; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then tar -zcf GrandView-${APP_VERSION}-${TRAVIS_OS_NAME}-${ARCH_NAME}.tar.gz -C .dist/linux-unpacked .; fi

  # Build app for Mac
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then npm run build:$TRAVIS_OS_NAME; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then tar -zcf GrandView-${APP_VERSION}-${TRAVIS_OS_NAME}-${ARCH_NAME}.tar.gz .dist/GrandView-${APP_VERSION}.dmg; fi

cache:
  directories:
  - .cache

deploy:
  provider: releases
  api_key:
    secure: vHqlOdMB9CCg9iRfWyFj3l4DoBH5EbXewa050i0BrzESFZOFaLYEmIUd9bo8p+c/xkHdIWL4c3mgK4LsWV23DMB153rPfhP9OmFZ9hXnQmk2zsfQqod07qxY7kdlvINR9Y3+9wjkRBDW8SsRX4vrFAHhYV2NHZW2P1Zz/MJ0sTfL/U3XTUvuXBXi9Qkeiq2lfF7c6xuaIbCGjxmAoWiPZi/cvsT9hbjbiiEgRZv7+HhzcvBf83E7scbuNO2HJ0tePe39ml7++7GZaBRf7x4b/j/CdsPjwO5cxCirKQyDn+3Fz63ss0KoXiW/WkmyAjDMpg6p5I/IER/hWldeXEHKItZcg1N2apM1N4zIaOsBW13ydWY21+O51HDYgNS4JqguAw0OI7fhPgtQjLdEmlKpaqg4envd08n3n7sqLUfThL0Tn0rchF80xyHU9miULqK+xH1FNae+tDRfp76t7GX/ZV3Xpu0LYKAv3sWzo/JF0VQohWd++K9KiauApqGMTd+MLcwFsB0JELz2beyTUKgqrHQzmRJCeCZQqLvDg+YUPzZuMwTKP/n2rK1E4VXt/0q0erZ8K+dSav2/2eqZvoi+byzQuhloQxCk+REeBScAy5MTAqiFuKoA/3FcOcb8T5vX962wBndf+PL7wEbkPnnaX3Rq14dHdtcYrfNWxDcERCA=
  file: GrandView-${APP_VERSION}-${TRAVIS_OS_NAME}-${ARCH_NAME}.tar.gz
  skip_cleanup: true
  on:
    repo: bompi88/grand-view
    tags: true
    condition: $TRAVIS_OS_NAME = "osx"

deploy:
  provider: releases
  api_key:
    secure: vHqlOdMB9CCg9iRfWyFj3l4DoBH5EbXewa050i0BrzESFZOFaLYEmIUd9bo8p+c/xkHdIWL4c3mgK4LsWV23DMB153rPfhP9OmFZ9hXnQmk2zsfQqod07qxY7kdlvINR9Y3+9wjkRBDW8SsRX4vrFAHhYV2NHZW2P1Zz/MJ0sTfL/U3XTUvuXBXi9Qkeiq2lfF7c6xuaIbCGjxmAoWiPZi/cvsT9hbjbiiEgRZv7+HhzcvBf83E7scbuNO2HJ0tePe39ml7++7GZaBRf7x4b/j/CdsPjwO5cxCirKQyDn+3Fz63ss0KoXiW/WkmyAjDMpg6p5I/IER/hWldeXEHKItZcg1N2apM1N4zIaOsBW13ydWY21+O51HDYgNS4JqguAw0OI7fhPgtQjLdEmlKpaqg4envd08n3n7sqLUfThL0Tn0rchF80xyHU9miULqK+xH1FNae+tDRfp76t7GX/ZV3Xpu0LYKAv3sWzo/JF0VQohWd++K9KiauApqGMTd+MLcwFsB0JELz2beyTUKgqrHQzmRJCeCZQqLvDg+YUPzZuMwTKP/n2rK1E4VXt/0q0erZ8K+dSav2/2eqZvoi+byzQuhloQxCk+REeBScAy5MTAqiFuKoA/3FcOcb8T5vX962wBndf+PL7wEbkPnnaX3Rq14dHdtcYrfNWxDcERCA=
  file:
    - GrandView-${APP_VERSION}-${TRAVIS_OS_NAME}-${ARCH_NAME}.tar.gz
    - GrandView_${APP_VERSION}_amd64.deb
    - GrandView-${APP_VERSION}-x86_64.AppImage
  skip_cleanup: true
  on:
    repo: bompi88/grand-view
    tags: true
    condition: $TRAVIS_OS_NAME = "linux"

notifications:
  email:
    on_success: never
    on_failure: always
